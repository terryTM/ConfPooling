#!/bin/bash
#SBATCH --job-name=pooling_all
#SBATCH --partition=gpu_p
#SBATCH --gres=gpu:A100:1
#SBATCH --ntasks=1
#SBATCH --mem=32G
#SBATCH --cpus-per-task=8
#SBATCH --time=48:00:00
#SBATCH --output=logs/%A_%a.log
#SBATCH --array=0-19   # é›†ç¾¤é™åˆ¶ï¼šæœ€å¤š 0-19ï¼Œä¸€å…± 20 ä¸ª task

# ---- 1. åŠ è½½å¿…è¦æ¨¡å— ----
source ~/.bashrc
module load CUDA/12.8.0

# ---- 2. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ ----
source ~/PY_envs/deepconf_py312/bin/activate

# ---- 3. è¿›å…¥é¡¹ç›®ç›®å½• ----
cd ~/Projects/Method/deepconf

nvidia-smi

# ---- 4. é…ç½®æ•°æ®é›† & ä»»åŠ¡åˆ†é… ----
DATASETS=("aime_2024" "aime_2025" "brumo_2025" "hmmt_2025")
NUM_DATASETS=${#DATASETS[@]}        # 4
QUESTIONS_PER_DATASET=30            # é¢˜å· 0-29
TOTAL_JOBS=$(( NUM_DATASETS * QUESTIONS_PER_DATASET ))   # 120

ARRAY_TASKS=20                      # array 0-19 ä¸€å…± 20 ä¸ª
JOBS_PER_TASK=$(( (TOTAL_JOBS + ARRAY_TASKS - 1) / ARRAY_TASKS ))  # å‘ä¸Šå–æ•´ = 6

TASK_ID=${SLURM_ARRAY_TASK_ID}
START_INDEX=$(( TASK_ID * JOBS_PER_TASK ))
END_INDEX=$(( START_INDEX + JOBS_PER_TASK - 1 ))

# é˜²æ­¢æœ€åä¸€ä¸ª task è¶Šç•Œ
if [ "$END_INDEX" -ge "$TOTAL_JOBS" ]; then
    END_INDEX=$(( TOTAL_JOBS - 1 ))
fi

echo "This Slurm array task (ID=${TASK_ID}) will process global job indices ${START_INDEX}..${END_INDEX}"

# ---- 5. ä¾æ¬¡è·‘åˆ†é…ç»™å½“å‰ array-task çš„å¤šä¸ª (dataset, qid) ----
for GLOBAL_ID in $(seq "$START_INDEX" "$END_INDEX"); do
    DATASET_INDEX=$(( GLOBAL_ID / QUESTIONS_PER_DATASET ))
    QID=$(( GLOBAL_ID % QUESTIONS_PER_DATASET ))
    DATASET_NAME=${DATASETS[$DATASET_INDEX]}

    OUT_DIR="data/processed/${DATASET_NAME}/pool_information_v5"
    OUT_PATH="${OUT_DIR}/${DATASET_NAME}_${QID}_deepconflow_self_check.jsonl"

    mkdir -p "$OUT_DIR"

    if [ -f "$OUT_PATH" ]; then
        echo "âœ… Skip: dataset=${DATASET_NAME}, QID=${QID}, file already exists at ${OUT_PATH}"
        continue
    fi

    echo "ğŸš€ Running: dataset=${DATASET_NAME}, QID=${QID}"
    python examples/online_RL/approach_exploration/pool_information/pool_information.py \
        --question_id "$QID" \
        --output_dir "$OUT_DIR" \
        --data_name "$DATASET_NAME"

    echo "âœ… Finished: dataset=${DATASET_NAME}, QID=${QID}"
done

echo "ğŸ‰ Slurm array task ${TASK_ID} done."
