#!/bin/bash
#SBATCH --job-name=data_creation_array
#SBATCH --partition=gpu_p
#SBATCH --gres=gpu:A100:1
#SBATCH --ntasks=1
#SBATCH --mem=32G
#SBATCH --cpus-per-task=8
#SBATCH --time=19:00:00
#SBATCH --output=logs/%A_%a.log
#SBATCH --array=0

# ---- 1. åŠ è½½å¿…è¦æ¨¡å— ----
module load CUDA/12.8.0

# ---- 2. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ ----
source ~/PY_envs/deepconf_py312/bin/activate

# ---- 3. è¿›å…¥é¡¹ç›®ç›®å½• ----
cd ~/Projects/Method/deepconf

nvidia-smi
echo "Starting SLURM array job ${SLURM_ARRAY_JOB_ID} with task ID ${SLURM_ARRAY_TASK_ID}"
date

# ======================
# ğŸ”¹ Trace åˆ†æ‰¹ç”Ÿæˆé€»è¾‘
# ======================
DATASET_NAME="hmmt_2025"
DATASET="/home/yz54720/Projects/Method/deepconf/data/raw/${DATASET_NAME}.jsonl"
QID=${SLURM_ARRAY_TASK_ID}
OUTDIR="/home/yz54720/Projects/Method/deepconf/data/processed/${DATASET_NAME}/traces"
mkdir -p ${OUTDIR}

TOTAL_TRACE=256
BATCH_SIZE=64  # æ¯æ‰¹ç”Ÿæˆ64æ¡ trace
NUM_BATCHES=$((TOTAL_TRACE / BATCH_SIZE))

for ((i=0; i<NUM_BATCHES; i++)); do
    OUTFILE="${OUTDIR}/${DATASET_NAME}_${QID}_part${i}.jsonl"

    # è‹¥æ–‡ä»¶å·²å­˜åœ¨åˆ™è·³è¿‡ï¼ˆæ”¯æŒæ–­ç‚¹ç»­è·‘ï¼‰
    if [ -f "${OUTFILE}" ]; then
        echo "[INFO] Skipping existing ${OUTFILE}"
        continue
    fi

    echo "[$(date)] Generating batch $i (QID=${QID})"

    # æ·»åŠ é”™è¯¯å¤„ç†
    if python examples/online_RL/data_creation.py \
        --dataset ${DATASET} \
        --qid ${QID} \
        --budget ${BATCH_SIZE} \
        --output_path ${OUTFILE}; then
        echo "[$(date)] Successfully finished batch $i"
    else
        echo "[ERROR] Failed to generate batch $i for QID=${QID}"
        exit 1
    fi
done

# ---- 5. åˆå¹¶åˆ†æ‰¹ç»“æœ ----
FINAL_FILE="${OUTDIR}/${DATASET_NAME}_${QID}_full.jsonl"
echo "[INFO] Merging all parts for QID=${QID}"

# æ›´å®‰å…¨çš„åˆå¹¶æ–¹å¼ï¼Œåªåˆå¹¶å½“å‰QIDçš„æ–‡ä»¶
if ls ${OUTDIR}/${DATASET_NAME}_${QID}_part*.jsonl 1> /dev/null 2>&1; then
    for f in ${OUTDIR}/${DATASET_NAME}_${QID}_part*.jsonl; do
        cat "$f" >> ${FINAL_FILE}
        echo >> ${FINAL_FILE}
    done
    echo "[SUCCESS] Saved full trace set to ${FINAL_FILE}"
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    echo "[INFO] Cleaning up temporary part files..."
    rm ${OUTDIR}/${DATASET_NAME}_${QID}_part*.jsonl
    echo "[INFO] Cleanup completed"
else
    echo "[WARNING] No part files found for QID=${QID}"
fi

date
echo "Finished SLURM task ID ${SLURM_ARRAY_TASK_ID}"